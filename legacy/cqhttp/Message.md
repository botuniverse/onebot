# 消息格式

目前在发送、上报、回复消息时，全面支持两种消息格式：字符串（string）和数组（array）。

在上述三种情况中，「发送」指的是调用 API 直接发送消息（`message` 字段），「上报」指的是接收到消息之后向指定地址上报事件信息（`message` 字段），「回复」指的是上报事件时的响应中的快速回复（`reply` 字段）。

其中，发送和回复时，同时支持字符串和数组格式的消息，插件会自动识别相应字段的类型，比如下面两段 JSON 都是允许的：

```json
{
    "message": "这是一条字符串格式的消息",
    "others...": "..."
}
```

```json
{
    "message": [
        {
            "type": "text",
            "data": {"text": "这是第一段"}
        },
        {
            "type": "face",
            "data": {"id": "111"}
        },
        {
            "type": "text",
            "data": {"text": "这是表情之后的一段"}
        }
    ]
}
```

而上报消息时，会根据配置文件中指定的格式来上报，默认为字符串格式，具体请见 [配置文件说明](Configuration) 的 `post_message_format` 项。

## 字符串格式

字符串格式是传统的消息格式，也是 CKYU 原生所使用的消息格式，无论纯文本还是图片、表情、链接分享等多媒体内容都放在同一个字符串中，即，一条消息对应一个字符串。

其中，多媒体内容使用 CQ 码来表示，形如 `[CQ:image,file=123.jpg]`，可以看出 CQ 码中包含一些特殊字符：`[`、`]`、`,` 等，而 CQ 码又是可能混杂在纯文本内容之中的，因此消息中的纯文本内容需要对特殊字符进行转义。关于 CQ 码的更多内容，见 CKYU 文档的 [CQ码](https://docs.cqp.im/manual/cqcode/)，以及本文档的 [CQ 码](CQCode) 部分。

## 消息段（广义 CQ 码）

在介绍数组格式之前，先对 CQ 码的概念进行扩展。

狭义的 CQ 码是指字符串格式下用于表示多媒体内容的方式，形如 `[CQ:image,file=123.jpg]`，在阅读官方文档之后可以知道，这里 CQ 码「功能名」为 `image`，「参数」为 `file=123.jpg`，也即等号分隔的一个「键值对」。

要使传统的字符串格式能转换成数组格式或相反，必须要将狭义的 CQ 码用另外的可扩展的方式表示，而不再是和纯文本混杂在一起，因此引入「广义 CQ 码」的概念，或称「消息段」，后面为了避免混淆，将主要使用「消息段」来指「广义 CQ 码」、使用「CQ 码」来指「狭义 CQ 码」。

### 格式

消息段的基本格式如下（以 JSON 对象形式给出）：

```json
{
    "type": "image",
    "data": {
        "file": "123.jpg",
        "url": "http://example.com/123.jpg"
    }
}
```

其中 `type` 字段的类型为字符串，对应狭义 CQ 码中的「功能名」，`data` 字段的类型为对象，对应狭义 CQ 码的「参数」，此字段可为 null，其中的内容即为 CQ 码参数的「键值对」。**注意，所有「值」均使用字符串表示**。

**由于消息段不再将纯文本和多媒体内容放在一起，也就意味着任意一个字段的值都是真实值，而不再需要转义。**

由此可以得出，任意 CQ 码都可以转换为一个消息段，任意消息段都可以转换成一个 CQ 码。

另外，为了使用消息段表示纯文本，引入一个「伪」CQ 码功能名 `text`，并在 `data` 中使用 `text` 字段来指示纯文本内容，例如：

```json
{
    "type": "text",
    "data": {
        "text": "这是一段纯文本"
    }
}
```

在将上面的消息段转成 CQ 码时，将会直接变成纯文本字符串，而不是真的转成 CQ 码。

## 数组格式

了解了「消息段」的概念之后，就不难理解消息的数组格式了，即消息段组成的数组。

例如，传统的字符串格式下的这样一条消息：

```
&#91;第一部分&#93;[CQ:image,file=123.jpg]图片之后的部分，表情：[CQ:face,id=123]
```

表示成数组格式即为：

```json
[
    {
        "type": "text",
        "data": {
            "text": "[第一部分]"
        }
    },
    {
        "type": "image",
        "data": {
            "file": "123.jpg"
        }
    },
    {
        "type": "text",
        "data": {
            "text": "图片之后的部分，表情："
        }
    },
    {
        "type": "face",
        "data": {
            "id": "123"
        }
    }
]
```
